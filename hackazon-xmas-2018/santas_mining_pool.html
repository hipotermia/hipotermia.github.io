<h3>[100] SHA256</h3>

<p class="challenge-description">Santa is launching his own crypto currency and is looking for miners with a lot of
    hashing power. To apply you need to proof you have some decent hashing power...<br>
    Please provide a hex encoded value, we will decode it and hash it with sha-256. If your value ends in at least 22
    zeroes we will give you the flag...</p>

<p>On this challenge only a webpage with an input to introduce the specified value is provided.</p>

<img class="img-fluid" src="/static/img/hackazon-xmas-2018/santas_mining_pool/1.PNG">

<p>The source code of the webpage is the following.</p>

<pre class="prettyprint">
import os
from flask import Flask, request, Response
import hashlib
f = open('flag.txt')
flag = f.readline().strip()

app = Flask(__name__)

@app.route('/')
def index():
    return """&lt;html>&lt;body>So you want to mine crypto currency with us. First proof you can actually calculate some hashes...&lt;br>
        Please provide a hex encoded value, we will decode it and hash it with sha-256. If your value ends in at least 22 zeroes we will give you the flag...
        &lt;form action="solve">
        Value (hex encoded): &lt;input name='val' type='text' size='80'>&lt;/input>
        &lt;/form>

        We believe in Kerckhoff's principle so we provide the &lt;a href="source">full source code&lt;/a>&lt;p>
        &lt;/body>&lt;/html>"""

@app.route('/source')
def source():
    s = os.popen('code2html -l python chall.py').read()
    return s

@app.route('/solve')
def challenge():
    val = request.args.get('val')
    try:
        val = val.decode('hex')
    except:
        return "Invalid value cannot hex decode it"
    h = hashlib.sha256(val).hexdigest()
    # Determine the number of zeroes this value ends with
    zero_count = 0
    for i in range(1,len(h)):
        if h[-1*i] == '0':
            zero_count += 1
        else:
            break

    if zero_count >= 22:
        return "Nice, have a flag: %s" % flag
    else:
        return "Sorry the hash of that value %s only ends in %s zeroes, we need at least 22" % (h, zero_count)
</pre>

<p>The code used is normal and nothing looks exploitable.</p>

<p>At first I made a simple script that generated random values and calculated the SHA256 hash to look if it ended with
    22 zeros, but then I calculated the possibilities and saw that it was almost impossible to get it on the the
    interval of time the CTF was up.</p>

<p>After spending too much time looking for solutions (I didn't finish first because of this) I saw Bitcoin was the way
    to go.<br>
    I already knew that Bitcoin hashes needed to start with some zeros, but didn't really know how it was calculated, <a
            href="https://en.bitcoin.it/wiki/Block_hashing_algorithm">here</a> it's explained.<br>
    The truth is that the hash calculated has to end in zeros, but then because of Endianess it's reversed and the
    zeros end in the front.</p>

<p>Knowing that, the only thing to do is search for bitcoin hash with more than 22 zeros, I used this one.</p>

<pre class="prettyprint">
    <a href="https://btc.com/0000000000000000000000bb5b432a764ad6c7acf677dcd99161abfdf68e698e">0000000000000000000000bb5b432a764ad6c7acf677dcd99161abfdf68e698e</a>
</pre>

<p>I looked for the values used to generate that hash and used the following script to get the hex value.</p>

<pre class="prettyprint">
import hashlib
from datetime import datetime

def r(h):
	ba = bytearray.fromhex(h)
	ba.reverse()
	return ''.join(format(x, '02x') for x in ba)

version = r("20000000")
prev_hash = r("0000000000000000000449fbead9e7413308a9395c4e236f51ee45216ab94a92")
merkle = r("d8b6eebb2554510b5778aa7596089ede30d802e5168939141059d1a5de823db4")
time =  r(hex(int(datetime(2017,12,19,21,57,34).strftime('%s'))).split('x')[-1])
bits = r("18009645")
nonce = r("3391bd0e")

header_hex = (version + prev_hash + merkle + time + bits + nonce)
header_bin = header_hex.decode('hex')
val = hashlib.sha256(header_bin).digest()
val = val.encode('hex')

print 'hex:', val

val = val.decode('hex')
h = hashlib.sha256(val).hexdigest()

print 'hash:', h
</pre>

<p>Run it to get the value and introduce it on the webpage to get the flag.</p>

<pre class="prettyprint">
root@kali:~/hackazon/santas_mining_pool# python c.py
hex: acaf843eaa355f719bac0bc848f040974498dc6d9456a8c69061a3eecb585759
hash: 8e698ef6fdab6191d9dc77f6acc7d64a762a435bbb0000000000000000000000
</pre>

<pre class="prettyprint">
Nice, have a flag: CTF{b19c37bc7c6fcb94f8c43b109272d38f}
</pre>