<h3>[300] Combination Lock</h3>

<p class="challenge-description">We have created a custom hashing algorithm to protect our passwords when stored in
    JavaScript. Can you reverse the algorithm?
    You will need to use a browser which supports WebAssembly.</p>

<p>On this challenge a <code>Combination Lock.html</code> file is given, open it with any web browser to see a webpage
    where a pincode is requested.</p>

<img class="img-fluid" src="/static/img/hackazon-xmas-2018/combination/1.PNG">

<p>Looking at the source code it's possible to see the function which is called when clicking the unlock button.</p>

<pre class="prettyprint">
var checkCombination = function checkCombination() {
    var inputs = document.querySelectorAll('.combination-input .text-value');
    var pinCode = [];
    for (var i = 0; i < inputs.length; i++) {
        pinCode.push(inputs[i].innerHTML.charCodeAt(0));
    }
    return m.exports.YwAQZc(pinCode[0],pinCode[1],pinCode[2],pinCode[3],pinCode[4],pinCode[5],pinCode[6],pinCode[7],pinCode[8],pinCode[9],pinCode[10],pinCode[11],pinCode[12],pinCode[13],pinCode[14],pinCode[15],pinCode[16],pinCode[17],pinCode[18],pinCode[19],pinCode[20],pinCode[21],pinCode[22],pinCode[23],pinCode[24],pinCode[25],pinCode[26],pinCode[27],pinCode[28],pinCode[29],pinCode[30],pinCode[31],pinCode[32],pinCode[33],pinCode[34],pinCode[35],pinCode[36]);
};
</pre>

<p>The function to check if the provided code is correct is written in web assembly. Here's the first part of it.</p>

<pre class="prettyprint">
func (param i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32) (result i32)
(local i32)
  i32.const 0
  set_local 37
  block
    get_local 0
    i32.const 24642
    i32.xor
    i32.const 1751212907
    i32.mul
    tee_local 0
    i32.const 0
    i32.load offset=16 align=4
    i32.ne
    br_if 0
    i32.const 0
    set_local 37
    i32.const 1751212907
    get_local 0
    i32.sub
    get_local 1
    i32.const 24642
    i32.xor
    i32.mul
    tee_local 0
    i32.const 0
    i32.load offset=20 align=4
    i32.ne
    br_if 0
    i32.const 0
    set_local 37
    i32.const 1751212907
    get_local 0
    i32.sub
    get_local 2
	...
</pre>

<p>The code is retrieving every character on the pin code, one by one, doing some calculations to it and comparing to a
    const value.<br>
    To get the flag I put a breakpoint after every <code>br_if 0</code> instruction, here is where the modified pincode
    char is compared to the const value.<br>
    I used the following javascript code to try every possible character and check if the breakpoint was reached, then
    the character was the correct and part of the flag.</p>

<pre class="prettyprint">
var flag = '';
var pinCode = new Array();
for(var i=0;i < flag.length;++i) pinCode[i] = flag[i].charCodeAt(0);
var chars = '0123456789abcdefghijklmnopqrstuvwxyz{}';
for (var i=0;i < chars.length;++i){
	console.log(chars[i]);
	pinCode[flag.length] = chars[i].charCodeAt(0);
	m.exports.YwAQZc(pinCode[0],pinCode[1],pinCode[2],pinCode[3],pinCode[4],pinCode[5],pinCode[6],pinCode[7],pinCode[8],pinCode[9],pinCode[10],pinCode[11],pinCode[12],pinCode[13],pinCode[14],pinCode[15],pinCode[16],pinCode[17],pinCode[18],pinCode[19],pinCode[20],pinCode[21],pinCode[22],pinCode[23],pinCode[24],pinCode[25],pinCode[26],pinCode[27],pinCode[28],pinCode[29],pinCode[30],pinCode[31],pinCode[32],pinCode[33],pinCode[34],pinCode[35],pinCode[36]);
}
</pre>